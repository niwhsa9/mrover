<template>
  <div class="wrap">
    <h3>Cameras ({{ num_available }} available)</h3>
    <div class="row justify-content-md-left">
      <div class="form-group col-md-4">
        <label for="Camera Name">Camera name</label>
        <input v-model="cameraName" type="message" class="form-control" id="CameraName" placeholder="Enter Camera Name">
        <small id="cameraDescrip" class="form-text text-muted"></small>
      </div>
      <div class="form-group col-md-4">
        <label for="Camera ID">Camera ID</label>
        <input v-model="cameraIdx" type="Number" min="0" max="8" class="form-control" id="CameraIdx"
          placeholder="Camera ID">
      </div>
      <button class="btn btn-primary custom-btn" @click="addCameraName()">
        Change Name
      </button>
    </div>
    <div class="cameraselection">
      <CameraSelection :cams-enabled="camsEnabled" :names="names" :capacity="capacity" @cam_index="setCamIndex($event)" />
    </div>
    <h3>All Cameras</h3>
    Capacity:
    <input v-model="capacity" type="Number" min="2" max="4" />
    <div v-for="i in camsEnabled.length" :key="i">
      <CameraInfo v-if="camsEnabled[i - 1]" :id="i - 1" :name="names[i - 1]" :stream="getStreamNum(i - 1)"
        @newQuality="changeQuality($event)" @swapStream="swapStream($event)"></CameraInfo>
    </div>
  </div>
</template>
  
<script lang="ts">
import CameraSelection from "../components/CameraSelection.vue";
import CameraInfo from "../components/CameraInfo.vue";
import { mapActions } from "vuex";

export default {
  components: {
    CameraSelection,
    CameraInfo
  },

  props: {
    primary: {
      type: Boolean,
      required: true
    }
  },
  data() {
    return {
      camsEnabled: new Array(9).fill(false),
      names: Array.from({ length: 9 }, (_, i) => "Camera: " + i),
      cameraIdx: 0,
      cameraName: "",
      capacity: 2,
      qualities: new Array(9).fill(-1),
      streamOrder: [-1, -1, -1, -1],

      available_sub: null,
      num_available: -1
    };
  },

  watch: {
    capacity: function (newCap, oldCap) {
      if (newCap < oldCap) {
        var numStreaming = this.streamOrder.filter((index) => index != -1);
        var ind = numStreaming.length - 1;
        this.setCamIndex(numStreaming[ind]);
      }
    }
  },

  created: function () {
    //   this.available_sub = new ROSLIB.Topic({
    //     ros: this.$ros,
    //     name: "available_cameras",
    //     messageType: "mrover/AvailableCameras"
    //   });

    //   this.available_sub.subscribe((msg) => {
    //     this.num_available = msg.num_available;
    //   });
  },

  methods: {
    ...mapActions('websocket', ['sendMessage']),

    setCamIndex: function (index: number) {
      //     //every time a button is pressed, it changes cam status and adds/removes from stream
      //     Vue.set(this.camsEnabled, index, !this.camsEnabled[index]);
      //     if (this.camsEnabled[index]) this.qualities[index] = 2; //if enabling camera, turn on medium quality
      //     this.changeStream(index);
    },

    sendCameras: function (index: number) {
      this.sendMessage({
        type: "sendCameras", primary: this.primary,
        device: index, resolution: this.qualities[index]
      });
    },

    addCameraName: function () {
      this.names[this.cameraIdx] = this.cameraName;
    },

    changeQuality({ index, value }) {
      this.qualities[index] = value;
      this.sendCameras(index);
    },

    swapStream({ prev, newest }) {
      //     var temp = this.streamOrder[prev];
      //     Vue.set(this.streamOrder, prev, this.streamOrder[newest]);
      //     Vue.set(this.streamOrder, newest, temp);
    },

    changeStream(index: number) {
      //     const found = this.streamOrder.includes(index);
      //     if (found) {
      //       this.streamOrder.splice(this.streamOrder.indexOf(index), 1);
      //       this.streamOrder.push(-1);
      //       this.qualities[index] = -1; //close the stream when sending it to comms
      //     } else Vue.set(this.streamOrder, this.streamOrder.indexOf(-1), index);
      //     this.sendCameras(index);
    },

    getStreamNum(index: number) {
      return this.streamOrder.indexOf(index);
    }

  }
};
</script>
  
<style scoped>
.cameraselection {
  margin: 10px;
}

.custom-btn {
  width: 150px;
  height: 50px;
}
</style>